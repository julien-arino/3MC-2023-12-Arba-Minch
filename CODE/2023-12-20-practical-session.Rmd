---
title: "Arba Minch practical session"
author: "Julien Arino"
date: "2023-12-20"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)

# During the course, I may not have the data, so I will turn this off.
ONLINE = FALSE

# Load/install some libraries we may need
if (!require(WHO)) {
  # Download WHO package tarball from CRAN archive since it was removed
  url <- "https://cran.r-project.org/src/contrib/Archive/WHO/WHO_0.2.1.tar.gz"
  pkgFile <- "WHO_0.2.1.tar.gz"
  download.file(url = url, destfile = pkgFile)
  # Install package (no dependencies here)
  install.packages(pkgs=pkgFile, type="source", repos=NULL)
  # Delete package tarball
  unlink(pkgFile)
  # Load library
  library(WHO)
}
if (!require(wbstats)) {
  install.packages("wbstats")
  library(wbstats)
}
if (!require(kableExtra)) {
  install.packages("kableExtra")
  library(kableExtra)
}
if (!require(dplyr)) {
  install.packages("dplyr")
  library(dplyr)
}
```

Note: just before the pandemic, I published a paper on "being data aware" in mathematical epidemiology. You can find it [here](). I also put a copy on the GitHub repo. Note that you should really look at the code of that paper, which has its [own repository](https://github.com/julien-arino/modelling-with-data), as the publisher did a very bad job of rendering the file.

## Getting some data online

You can get some WHO data about Ethiopia from [here](https://data.who.int/countries/231), which will point you back [here](https://www.who.int/data/gho/data/themes/mortality-and-global-health-estimates/ghe-leading-causes-of-death) for leading causes of death. 

Let us see, however, if we can get the data directly from R. Two libraries may prove useful: `WHO` (but this was "removed for policy violation", so who knows) and `wbstats`, which gets data from the World Bank.


```{r get_data}
if (ONLINE) {
  # WHO data sets
  WHO_data_sets <- get_codes()
  saveRDS(WHO_data_sets, "DATA/WHO_data_sets.rds")
  # World Bank data sets
  WB_data_sets <- wbstats::wb_indicators()
  saveRDS(WB_data_sets, "DATA/WB_data_sets.rds")
} else {
  WHO_data_sets <- readRDS("DATA/WHO_data_sets.rds")
  WB_data_sets <- readRDS("DATA/WB_data_sets.rds")
}
```

### WHO data sets

```{r display_WHO_data, include=TRUE}
kableExtra::kbl(WHO_data_sets$display) %>%
  kableExtra::scroll_box(height = "300px")
```

### World Bank data sets

```{r display_WB_data, include=TRUE}
kableExtra::kbl(head(WB_data_sets$indicator_desc, 20)) %>%
  kableExtra::scroll_box(height = "300px")
```

### We need to find the right data set

Those data sets are huge: there are `r nrow(WHO_data_sets)` data sets in the WHO data, and `r nrow(WB_data_sets)` in the World Bank data. We need to find the right one.
Let us look for example for the word "mortality" in both data sets and see what we get.

```{r find_mortality, include=TRUE}
idx_mortablity_WHO = union(
  grep("mortality", WHO_data_sets$display, ignore.case = TRUE),
  grep("death", WHO_data_sets$display, ignore.case = TRUE))
idx_mortablity_WB = union(
  grep("mortality", WB_data_sets$indicator_desc, ignore.case = TRUE),
  grep("death", WB_data_sets$indicator_desc, ignore.case = TRUE))
```

Display the indices we found. First, from WHO



```{r display_mortality_WHO, include=TRUE}
kableExtra::kbl(WHO_data_sets$display[idx_mortablity_WHO]) %>%
  kableExtra::scroll_box(height = "300px")
```

Then World Bank

```{r display_mortality_WB, include=TRUE}
kableExtra::kbl(WB_data_sets$indicator_desc[idx_mortablity_WB]) %>%
  kableExtra::scroll_box(height = "300px")
```


You see the idea... Most of the epidemiologicalm data in WB comes from WHO, so from now on, we just focus on WHO data for this.

## Tuberculosis

As no group was given tuberculosis (TB), let us look for that.

```{r find_TB, include=TRUE}
idx_TB_WHO = grep("tuberculosis", WHO_data_sets$display, ignore.case = TRUE)
```

Display the indices we found.


```{r display_TB_WHO, include=TRUE}
kableExtra::kbl(WHO_data_sets[idx_TB_WHO,]) %>%
  kableExtra::scroll_box(height = "300px")
```


```{r}
TB_data = wb_data("SH.TBS.INCD") %>%
  filter(country == "Ethiopia")
```

```{r}
RHS_TB <- function(t, x, p) {
  with(as.list(c(x,p)), {
    dS <- b-d*S-beta_S*S*I
    dL <- beta_S*S*I+gamma_T*T+gamma_I*I-(d+epsilon+t_L)*L
    dI <- epsilon*L+beta_T*T*I-(d+delta+gamma_I+t_I)*I
    dT <- -beta_T*T*I-(d+gamma_T)*T+t_L*L+t_I*I
    return(list(c(dS, dL, dI, dT)))
  })
}
```